<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Goals – Fitness Dashboard</title>
<style>
:root{
  --crimson:#8C001A;        
  --crimson-600:#a30020; 
  --bg:#ffffff; 
  --ink:#222222; 
  --muted:#6b7280;  
  --card:#ffffff; 
  --border:#8c001a33;  
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;z-index:10;background:var(--card);border-bottom:2px solid var(--crimson)}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.title{font-weight:800;color:var(--crimson)}
.sub{color:var(--muted);font-size:14px}
nav{border-top:1px solid var(--border);background:#fff;}
.tabs{display:flex;flex-wrap:wrap;gap:8px;padding:10px 16px}
.tab{display:inline-flex;align-items:center;gap:8px;border:1.5px solid var(--border);border-radius:999px;padding:8px 12px;text-decoration:none;color:var(--crimson);font-weight:600}
.tab:hover{border-color:var(--crimson);}
main .wrap{padding-top:16px}
.card{background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:14px;margin-bottom:20px}
.card h3{margin:0 0 8px;color:var(--crimson);font-size:18px}
.goal-item{border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px;}
.goal-item h4{margin:0;color:var(--crimson)}
.goal-item .muted{font-size:13px;color:var(--muted)}
.goal-buttons{margin-top:8px;display:flex;gap:8px;}
form{display:grid;gap:10px;margin-top:10px;}
input, select{padding:8px;border:1.5px solid var(--border);border-radius:8px;width:100%;}
button{background:var(--crimson);color:white;border:none;border-radius:8px;padding:10px;font-weight:600;cursor:pointer;}
button:hover{background:var(--crimson-600);}
button.delete-btn{background:#aaa;color:white;}
button.delete-btn:hover{background:#888;}
label{font-weight:600;font-size:14px}
.progress-container{background:#eee;border-radius:8px;overflow:hidden;height:16px;margin:6px 0;}
.progress-bar{background:#8C001A;height:100%;width:0%;transition:width 0.5s;text-align:center;color:white;font-size:12px;line-height:16px;}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">Fitness Dashboard</div>
    <div class="sub">Track and update your goals</div>
  </div>
  <nav>
    <div class="wrap">
      <div class="tabs">
        <a class="tab" href="/home">Home</a>
        <a class="tab" href="/food.html">Food</a>
        <a class="tab" href="/exercise.html">Exercise</a>
        <a class="tab" href="/goals-page" style="border-color:var(--crimson);">Goals</a>
        <a class="tab" href="/weekly.html">Weekly Log</a>
        <a class="tab" href="/profile.html">Profile</a>
        <a class="tab" href="/social.html">Social</a>
      </div>
    </div>
  </nav>
</header>

<main>
  <div class="wrap">

    <!-- Add New Goal -->
    <section class="card" id="add-goal-section">
      <h3>Add New Goal</h3>
      <form id="goalForm">
        <label for="goalName">Goal Name</label>
        <input type="text" id="goalName" placeholder="Enter goal name" required>

        <label for="goalTarget">Target Value</label>
        <input type="number" id="goalTarget" placeholder="Enter target value" required>

        <label for="goalStart">Start Date</label>
        <input type="date" id="goalStart" required>

        <label for="goalEnd">End Date</label>
        <input type="date" id="goalEnd">

        <button type="submit">Add Goal</button>
      </form>
    </section>

    <!-- Goals List -->
    <section class="card" id="goals-section">
      <h3>My Goals</h3>
      <div id="goalsList">
        <p class="muted">Loading goals...</p>
      </div>
    </section>

    <!-- Add Progress -->
    <section class="card" id="progress-section">
      <h3>Add Progress</h3>
      <form id="progressForm">
        <label for="goalSelect">Goal</label>
        <select id="goalSelect"></select>

        <label for="progressValue">Progress Value</label>
        <input type="number" id="progressValue" placeholder="Enter progress amount" required>

        <button type="submit">Add Progress</button>
      </form>
    </section>

  </div>
</main>

<footer>
  <div class="wrap">
    <p style="text-align:center;color:var(--muted);font-size:12px">Fitness Dashboard © 2025</p>
  </div>
</footer>

<script>
async function fetchGoals() {
  try {
    const res = await fetch('/goals');
    if (!res.ok) throw new Error('Failed to fetch goals');
    const data = await res.json();
    return data.goals || [];
  } catch (err) {
    console.error(err);
    return [];
  }
}

async function renderGoals() {
  const goals = await fetchGoals();
  const container = document.getElementById('goalsList');
  const select = document.getElementById('goalSelect');

  container.innerHTML = '';
  select.innerHTML = '';

  if (goals.length === 0) {
    container.innerHTML = '<p class="muted">No goals yet. Add one using the form above.</p>';
    return;
  }

  goals.forEach(g => {
    const progressPercent = g.total_progress ? Math.min(100, (g.total_progress / g.target_value) * 100) : 0;

    const div = document.createElement('div');
    div.className = 'goal-item';
    div.innerHTML = `
      <h4>${g.goal_name}</h4>
      <div class="muted">
        Start: ${g.start_date} | End: ${g.end_date || '—'} | Target: ${g.target_value}
      </div>
      <div class="progress-container">
        <div class="progress-bar" style="width:${progressPercent}%">${Math.round(progressPercent)}%</div>
      </div>
      <div class="goal-buttons">
        <button class="complete-btn" data-id="${g.id}">
          ${g.completed ? "Mark Incomplete" : "Mark Complete"}
        </button>
        <button class="delete-btn" data-id="${g.id}">Delete</button>
      </div>
    `;
    container.appendChild(div);

    if (!g.completed) {
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = g.goal_name;
      select.appendChild(opt);
    }
  });

  document.querySelectorAll('.complete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      await fetch(`/goals/toggle-complete/${id}`, { method: 'PATCH' });
      renderGoals();
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const confirmed = confirm("Are you sure you want to delete this goal?");
      if (!confirmed) return;

      await fetch(`/goals/${id}`, { method: 'DELETE' });
      renderGoals();
    });
  });
}

// Add new goal
document.getElementById('goalForm').addEventListener('submit', async e => {
  e.preventDefault();
  const goal_name = document.getElementById('goalName').value.trim();
  const target_value = parseFloat(document.getElementById('goalTarget').value);
  const start_date = document.getElementById('goalStart').value;
  const end_date = document.getElementById('goalEnd').value;

  if (!goal_name || !start_date || isNaN(target_value)) return;

  try {
    const res = await fetch('/goals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ goal_name, target_value, start_date, end_date })
    });
    if (res.ok) {
      document.getElementById('goalForm').reset();
      renderGoals();
    }
  } catch (err) {
    console.error(err);
  }
});

// Add progress
document.getElementById('progressForm').addEventListener('submit', async e => {
  e.preventDefault();
  const goalId = +document.getElementById('goalSelect').value;
  const val = +document.getElementById('progressValue').value;
  if (!goalId || isNaN(val) || val <= 0) return;

  try {
    const res = await fetch('/goal-progress', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ goal_id: goalId, progress_value: val })
    });
    if (res.ok) {
      document.getElementById('progressValue').value = '';
      renderGoals();
    }
  } catch (err) {
    console.error(err);
  }
});

renderGoals();
</script>
</body>
</html>
